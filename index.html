<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopFinds - Home</title>
  <!-- Google Fonts -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" as="style">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="logo-squared.jpg" type="image/jpeg">
  <style>
    body {
      background-color: #1b1a31;
      color: #ffffff;
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .logo-container {
        width: 100%;
        max-width: 600px; /* Gleiche Maximalbreite wie in der Privacy Policy */
        height: 180px; /* H√∂he des Logos basierend auf dem Seitenverh√§ltnis */
        margin: 40px auto 0px auto;
        display: block;
        border-radius: 0;
    }

    .logo {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 0;
        aspect-ratio: 914 / 249; /* Seitenverh√§ltnis bleibt erhalten */
    }

    .disclaimer {
      font-size: 16px;
      font-style: italic;
      font-weight: normal;
      color: gray;
      margin-top: 0;
      margin-bottom: 60px;
      text-align: center;
    }

    .search-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      margin-top: 10px;
      width: 100%;
      max-width: 900px;
      background-color: #2f2f2f;
      border-radius: 8px;
    }

    #search-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px 0 0 8px;
      outline: none;
      color: #ffffff;
      background-color: transparent;
    }

    #search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    #search-button {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 0 8px 8px 0;
      background-color: #2f2f2f;
      color: #ffffff;
      cursor: pointer;
    }

    #search-button:hover {
      background-color: #444;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 900px;
      width: 100%;
      margin-bottom: 100px;  /* Add this line */
    }

    .tile-wrapper {
      display: flex;
      flex-direction: column;
      background-color: transparent;
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    .tile-wrapper:hover {
      transform: translateY(-5px);
    }

    .tile {
      background-color: #2a2a2a;
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      aspect-ratio: 1 / 1;
      position: relative;
    }

    .tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }

    .tile:hover img {
      transform: scale(1.05);
    }

    .product-name-box {
      margin-top: -10px;
      background-color: #2f2f2f;
      color: #ffffff;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      padding: 6px 4px;
      border-radius: 0 0 12px 12px;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
 
    footer {
      margin-top: auto;  /* Changed from margin-top: 100px */
      text-align: center;
      font-size: 14px;
      color: rgb(80, 80, 80);
      padding-bottom: 20px;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .logo-container {
        height: 110px;
        margin-top: 20px;
      }

      .disclaimer {
        font-size: 13px;
        margin-bottom: 30px;
      }

      .search-bar {
        margin-top: 0;
        margin-bottom: 15px;
      }
      
      .product-name-box {
        font-size: 12px;
        padding: 5px 3px;
      }
    }

    /* Desktop */
    @media (min-width: 1024px) {
      .logo {
        margin-top: 10px;
      }

      footer {
        margin-top: 100px;
      }
    }

    /* TikTok overlay styles */
    .tiktok-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .arrow-image {
      position: fixed;
      top: 5px;
      right: 50px;
      width: 130px;
      height: auto;
    }

    .tiktok-box {
      width: 300px;
      background-color: #24243f;
      color: white;
      font-family: Arial, sans-serif;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,1);
      overflow: hidden;
    }

    .tiktok-box-header {
      margin-top: 5px;
      padding: 16px;
      font-size: 21px;
      font-weight: bold;
      text-align: center;
      border-bottom: 3px solid #3f4a55;
    }

    .tiktok-box-body {
      padding: 16px;
      font-size: 16px;
      line-height: 1.5;
      text-align: center;
    }
  </style>
</head>
<body>

  <a href="/">
      <div class="logo-container">
          <img src="logo.png" alt="Logo" class="logo" loading="eager" width="914" height="249">
      </div>
  </a>

  <p class="disclaimer">As an Amazon Associate, I earn from qualifying purchases.</p>

  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search for any product">
    <button id="search-button">üîç</button>
  </div>

  <div class="grid-container" id="grid-container">
    <!-- Placeholder tiles -->
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
  </div>

  <script>
    // Add this at the start of your script
    (async () => {
      const userAgent = navigator.userAgent.toLowerCase();
      const isTikTok = userAgent.includes('bytedance') || userAgent.includes('musical');
      
      if (isTikTok) {
        const overlay = document.createElement('div');
        overlay.className = 'tiktok-overlay';
        
        const arrow = document.createElement('img');
        arrow.src = 'arrow.png';
        arrow.className = 'arrow-image';
        arrow.alt = 'Arrow pointing to menu';
        
        const tiktokBox = document.createElement('div');
        tiktokBox.className = 'tiktok-box';
        tiktokBox.innerHTML = `
          <div class="tiktok-box-header">
            Open in Browser
          </div>
          <div class="tiktok-box-body">
            This Website only works in browser.<br>
            Click ( ‚Ä¢‚Ä¢‚Ä¢ ) in the top right corner,<br>
            then press "Open In Browser".
          </div>
        `;
        
        overlay.appendChild(arrow);
        overlay.appendChild(tiktokBox);
        document.body.appendChild(overlay);
      }
    })();

    let userCountry = 'US'; // Default to US
    const validCountries = ['US', 'AU', 'CA', 'FR', 'DE', 'IT', 'ES', 'GB'];
    const countryColumnMap = {
      'US': 1, 'AU': 2, 'CA': 3, 'FR': 4,
      'DE': 5, 'IT': 6, 'ES': 7, 'GB': 8
    };

    // Wait for country detection before loading products
    async function initializeApp() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        if (validCountries.includes(data.country)) {
          userCountry = data.country;
        }
        console.log('Detected country:', userCountry);
        document.getElementById('country-display').textContent = userCountry;
        
        // Now load products with correct country
        await fetchAndProcessCSV();
      } catch (error) {
        console.error('Error detecting country:', error);
        // Fall back to loading products with default US
        await fetchAndProcessCSV();
      }
    }

    const gridContainer = document.getElementById("grid-container");
    const searchInput = document.getElementById("search-input");

    const host = window.location.host;
    const productsCsvUrl = host === "127.0.0.1:5500"
      ? "https://docs.google.com/spreadsheets/d/17W9pOU5n4GCEb0WBQ0O2QecztUB2djmRxwk9tCJNDcI/export?format=csv"
      : "data.csv";
    const countryLinksUrl = host === "127.0.0.1:5500"
      ? "https://raw.githubusercontent.com/jxllyy/webproject/refs/heads/main/countrylinks.csv"
      : "countrylinks.csv";

    async function fetchAndProcessCSV() {
      try {
        // Fetch both CSVs
        const [productsResponse, countryLinksResponse] = await Promise.all([
          fetch(productsCsvUrl),
          fetch(countryLinksUrl)
        ]);

        if (!productsResponse.ok || !countryLinksResponse.ok) 
          throw new Error("Failed to fetch CSV files");

        const productsText = await productsResponse.text();
        const countryLinksText = await countryLinksResponse.text();

        // Process products CSV
        const productRows = productsText.split("\n").map(row => row.split(","));
        const validProductRows = productRows.filter(row => row[0]?.trim());

        // Process country links CSV
        const countryLinksRows = countryLinksText.split("\n").map(row => row.split(","));

        gridContainer.innerHTML = "";

        const firstSixPromises = [];
        const firstSixTiles = [];

        validProductRows.forEach((row, index) => {
          const [productName, , , imageFile] = row.map(cell => cell.trim());
          
          // Get the correct affiliate link based on country
          const countryLinksRow = countryLinksRows[index];
          let affiliateLink = null;
          
          if (countryLinksRow) {
            const columnIndex = countryColumnMap[userCountry];
            if (columnIndex && countryLinksRow[columnIndex]) {
              affiliateLink = countryLinksRow[columnIndex].trim();
              console.log(`Link for ${userCountry}:`, affiliateLink); // Debug output
            }
          }

          const tileWrapper = document.createElement("div");
          tileWrapper.className = "tile-wrapper";

          const tile = document.createElement("div");
          tile.className = "tile";

          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = productName || `Product Image ${index + 1}`;

          if (index < 6) {
            img.src = `product images/smaller/${imageFile || `product${index + 1}.jpg`}`;

            const imgPromise = new Promise(resolve => {
              img.onload = () => resolve();
              img.onerror = () => {
                img.src = "product images/placeholder.jpg";
                resolve();
              };
            });
            firstSixPromises.push(imgPromise);
            firstSixTiles.push({ img, imageFile, index });
          } else {
            img.src = `product images/${imageFile || `product${index + 1}.jpg`}`;
            img.onerror = () => {
              img.src = "product images/placeholder.jpg";
            };
          }

          tile.appendChild(img);

          // Create link overlay
          const overlay = document.createElement("div");
          overlay.style.position = "absolute";
          overlay.style.top = "0";
          overlay.style.left = "0";
          overlay.style.width = "100%";
          overlay.style.height = "100%";
          overlay.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
          overlay.style.color = "white";
          overlay.style.display = "flex";
          overlay.style.justifyContent = "center";
          overlay.style.alignItems = "center";
          overlay.style.fontSize = "12px";
          overlay.style.padding = "10px";
          overlay.style.textAlign = "center";
          overlay.style.wordBreak = "break-word";
          
          if (affiliateLink) {
            overlay.textContent = affiliateLink;
          } else {
            overlay.textContent = "no link available";
          }
          tile.appendChild(overlay);

          tile.addEventListener("click", () => {
            if (affiliateLink) {
              window.open(affiliateLink, "_blank");
            } else {
              window.open("https://www.amazon.com", "_blank");
            }
          });

          const nameBox = document.createElement("div");
          nameBox.className = "product-name-box";
          nameBox.textContent = productName;

          tileWrapper.appendChild(tile);
          tileWrapper.appendChild(nameBox);
          gridContainer.appendChild(tileWrapper);
        });

        await Promise.all(firstSixPromises);

        firstSixTiles.forEach(({ img, imageFile, index }) => {
          const bigImg = new Image();
          bigImg.src = `product images/${imageFile || `product${index + 1}.jpg`}`;
          bigImg.onload = () => {
            img.src = bigImg.src;
          };
        });

      } catch (error) {
        console.error("Error fetching or processing CSV:", error);
      }
    }

    // Start the app
    initializeApp();

    searchInput.addEventListener("input", () => {
      const searchTerm = searchInput.value.toLowerCase();
      const tiles = document.querySelectorAll(".tile-wrapper");

      tiles.forEach(tile => {
        const productName = tile.querySelector(".product-name-box").textContent.toLowerCase();
        tile.style.display = productName.includes(searchTerm) ? "flex" : "none";
      });
    });
  </script>

  <footer>
    <a href="privacy.html" style="color: gray; text-decoration: none; margin-right: 15px;">Privacy Policy</a>
    <a href="legal.html" style="color: gray; text-decoration: none; margin-right: 15px;">Legal Notice</a>
    <a href="test.html" style="color: gray; text-decoration: none; margin-right: 15px;">Test</a>
    <span id="country-display" style="color: gray;"></span>
  </footer>
</body>
</html>
