<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopFinds - Home</title>
  <!-- Google Fonts -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" as="style">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="logo-squared.jpg" type="image/jpeg">
  <style>
    body {
      background-color: #1b1a31;
      color: #ffffff;
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .logo-container {
        width: 100%;
        max-width: 600px; /* Gleiche Maximalbreite wie in der Privacy Policy */
        height: 180px; /* H√∂he des Logos basierend auf dem Seitenverh√§ltnis */
        margin: 40px auto 0px auto;
        display: block;
        border-radius: 0;
    }

    .logo {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 0;
        aspect-ratio: 914 / 249; /* Seitenverh√§ltnis bleibt erhalten */
    }

    .disclaimer {
      font-size: 16px;
      font-style: italic;
      font-weight: normal;
      color: gray;
      margin-top: 0;
      margin-bottom: 60px;
      text-align: center;
    }

    .search-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      margin-top: 10px;
      width: 100%;
      max-width: 900px;
      background-color: #2f2f2f;
      border-radius: 8px;
    }

    #search-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px 0 0 8px;
      outline: none;
      color: #ffffff;
      background-color: transparent;
    }

    #search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    #search-button {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 0 8px 8px 0;
      background-color: #2f2f2f;
      color: #ffffff;
      cursor: pointer;
    }

    #search-button:hover {
      background-color: #444;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 900px;
      width: 100%;
      margin-bottom: 100px;  /* Add this line */
    }

    .tile-wrapper {
      display: flex;
      flex-direction: column;
      background-color: transparent;
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    .tile-wrapper:hover {
      transform: translateY(-5px);
    }

    .tile {
      background-color: #2a2a2a;
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      aspect-ratio: 1 / 1;
      position: relative;
    }

    .tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }

    .tile:hover img {
      transform: scale(1.05);
    }

    .product-name-box {
      margin-top: -10px;
      background-color: #2f2f2f;
      color: #ffffff;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      padding: 6px 4px;
      border-radius: 0 0 12px 12px;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
 
    footer {
      margin-top: auto;  /* Changed from margin-top: 100px */
      text-align: center;
      font-size: 14px;
      color: rgb(80, 80, 80);
      padding-bottom: 20px;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
      }

      .logo-container {
        height: 110px;
        margin-top: 30px;
      }

      .disclaimer {
        font-size: 13px;
        margin-bottom: 50px;
      }

      .search-bar {
        margin-top: 0;
        margin-bottom: 20px;
      }
    }

    /* Desktop */
    @media (min-width: 1024px) {
      .logo {
        margin-top: 10px;
      }

      footer {
        margin-top: 100px;
      }
    }
  </style>
</head>
<body>

  <a href="/">
      <div class="logo-container">
          <img src="logo.png" alt="Logo" class="logo" loading="eager" width="914" height="249">
      </div>
  </a>

  <p class="disclaimer">As an Amazon Associate, I earn from qualifying purchases.</p>

  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search for any product">
    <button id="search-button">üîç</button>
  </div>

  <div class="grid-container" id="grid-container">
    <!-- Placeholder tiles -->
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
    <div class="tile-wrapper placeholder">
      <div class="tile"></div>
      <div class="product-name-box">Loading...</div>
    </div>
  </div>

  <script>
    const gridContainer = document.getElementById("grid-container");
    const searchInput = document.getElementById("search-input");

    const host = window.location.host;
    const csvUrl = host === "127.0.0.1:5500"
      ? "https://docs.google.com/spreadsheets/d/17W9pOU5n4GCEb0WBQ0O2QecztUB2djmRxwk9tCJNDcI/export?format=csv"
      : "data.csv";

    function convertToAmazonSchemeLink(url) {
      if (!url) return "amzn://";
      
      // Extract ASIN from URL if present
      const asinMatch = url.match(/(?:dp|product|gp\/product)\/([A-Z0-9]{10})/i);
      const asin = asinMatch ? asinMatch[1] : null;
      
      if (asin) {
        return `amzn://detail?asin=${asin}`;
      }
      
      // If no ASIN found, try to convert the URL to a scheme link
      try {
        const urlObj = new URL(url);
        if (urlObj.hostname.includes('amazon.')) {
          const path = urlObj.pathname;
          return `amzn://${path.replace(/^\//, '')}`;
        }
      } catch (e) {
        console.error("Error converting URL:", e);
      }
      
      return "amzn://";
    }

    async function fetchAndProcessCSV() {
      try {
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error("Failed to fetch CSV file");
        const csvText = await response.text();

        const rows = csvText.split("\n").map(row => row.split(","));
        const validRows = rows.filter(row => row[0]?.trim());
        gridContainer.innerHTML = "";

        const firstSixPromises = [];
        const firstSixTiles = [];

        validRows.forEach((row, index) => {
          const [productName, fallbackLink, affiliateLink, imageFile] = row.map(cell => cell.trim());

          const tileWrapper = document.createElement("div");
          tileWrapper.className = "tile-wrapper";

          const tile = document.createElement("div");
          tile.className = "tile";

          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = productName || `Product Image ${index + 1}`;

          if (index < 6) {
            img.src = `product images/smaller/${imageFile || `product${index + 1}.jpg`}`;

            const imgPromise = new Promise(resolve => {
              img.onload = () => resolve();
              img.onerror = () => {
                img.src = "product images/placeholder.jpg";
                resolve();
              };
            });
            firstSixPromises.push(imgPromise);
            firstSixTiles.push({ img, imageFile, index });
          } else {
            img.src = `product images/${imageFile || `product${index + 1}.jpg`}`;
            img.onerror = () => {
              img.src = "product images/placeholder.jpg";
            };
          }

          tile.appendChild(img);

          if (!affiliateLink) {
            const overlay = document.createElement("div");
            overlay.style.position = "absolute";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.width = "100%";
            overlay.style.height = "100%";
            overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
            overlay.style.color = "white";
            overlay.style.display = "flex";
            overlay.style.justifyContent = "center";
            overlay.style.alignItems = "center";
            overlay.style.fontSize = "14px";
            overlay.textContent = fallbackLink ? "no aff. link" : "no aff. & prod. link";
            tile.appendChild(overlay);
          }

          tile.addEventListener("click", () => {
            // Use Amazon scheme link first, fallback to regular links
            const schemeLink = convertToAmazonSchemeLink(affiliateLink || fallbackLink);
            
            // Try to open the app with scheme link
            window.location.href = schemeLink;
            
            // Fallback to regular link if scheme doesn't work
            setTimeout(() => {
              if (!document.hidden) {
                const link = affiliateLink || fallbackLink || "https://www.amazon.com";
                window.open(link, "_blank");
              }
            }, 500);
          });

          const nameBox = document.createElement("div");
          nameBox.className = "product-name-box";
          nameBox.textContent = productName;

          tileWrapper.appendChild(tile);
          tileWrapper.appendChild(nameBox);
          gridContainer.appendChild(tileWrapper);
        });

        await Promise.all(firstSixPromises);

        firstSixTiles.forEach(({ img, imageFile, index }) => {
          const bigImg = new Image();
          bigImg.src = `product images/${imageFile || `product${index + 1}.jpg`}`;
          bigImg.onload = () => {
            img.src = bigImg.src;
          };
        });

      } catch (error) {
        console.error("Error fetching or processing CSV:", error);
      }
    }

    fetchAndProcessCSV();

    searchInput.addEventListener("input", () => {
      const searchTerm = searchInput.value.toLowerCase();
      const tiles = document.querySelectorAll(".tile-wrapper");

      tiles.forEach(tile => {
        const productName = tile.querySelector(".product-name-box").textContent.toLowerCase();
        tile.style.display = productName.includes(searchTerm) ? "flex" : "none";
      });
    });
  </script>

  <footer>
    <a href="privacy.html" style="color: gray; text-decoration: none; margin-right: 15px;">Privacy Policy</a>
    <a href="legal.html" style="color: gray; text-decoration: none;">Legal Notice</a>
  </footer>
</body>
</html>